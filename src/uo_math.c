#include "uo_math.h"

#include <stdbool.h>

float testmat1[] = { 2.7, 6.6, 1.1, 0.8, -0.2, -6.9, 4.3, 6.9, 2.8, 4.1, 8.2, -5.6, -5.8, -1.4, -4.8, 2.9, 1.8, 1.1, -9.5, 6.2, 6.5, -8.1, 4.9, 8.4, -3.1, -6.7, 4.9, 3.2, -6.8, -6.3, -4.5, -3.6, 8.3, -5, -8, 4.6, 1.3, -1.6, -2.9, -8.8, 2.7, 5.2, -5.8, 0.5, -7.2, -0.4, -0.1, -2, -2.4, -1, 3.9, 4.5, 7, 1.8, -5.4, 8.2, -6, -2, -7, -8.2, -4, 9, -2.4, -6, 6.4, 2.5, 7.7, -6.3, -9.3, -6.1, -4, -1.9, 4.3, -0.2, 1.2, -0.6, 8.4, 6.4, 7.3, 3.3, 7.4, 1.9, -3.2, 0.8, -8.8, 5.4, 1.8, 5.5, -6, -2.1, 8.6, -8.4, -6.9, 5, 5.2, 8.5, -7.9, -6.9, 1.6, -1.9, -7.7, -6, -9.4, 6.8, 9.4, -6.1, -6, -7.9, -4.7, -9.6, -4.1, -3.6, 0.8, -6.5, 8.7, 2.9, 8.4, 7.6, -0.7, -9.6, -6.9, 6, 8, 3, -6.7, 8.2, 1, -7.1 };
float testmat2[] = { 4.8, 6.7, 5.4, -3.8, -6.1, 1.3, -9.9, -3.9, 5.2, 1.1, 8.6, 9.3, -5.4, 3.4, -8, 6.3, -4.4, 2.5, -0.5, -2.7, 0, -8.7, 9.8, -6.4, -8.5, -3.5, -2.1, 9.1, -5.5, -6.7, -3.8, 1, 4.8, 4.6, 5.3, 5.8, -0.5, -7.8, -6.7, 4.8, -3.7, 2.6, 7, -6.8, 3.7, 7.6, 3.8, -3.8, -6.1, 8.3, -8.5, 2.6, 9.2, 7.8, -2.5, 2.4, 0.6, -9.7, -7.8, 0.6, -6.6, 7.7, -6.3, -7.6, -2.7, 7.2, 3.9, -3.4, -5.3, 8.6, 7.3, -3, 7, 4.4, 3.9, 1.8, 0.3, 2.9, -2.6, -4.6, 8.1, 8.3, 5.9, 6.4, -1.4, 0.6, 8, 4, 8.7, -2.2, 0.5, -2.3, -6.8, 3.2, 8, 4.4, -3, -3.7, -6.3, -0.8, -2.2, 7.7, 1.7, 0.5, -8, 2.6, -4.4, 3.3, -8.6, -7, 5.6, -6.9, 0.7, 7, -9.1, -7.7, 2.1, 7, 5.9, 0.3, -9.1, 9.2, -2.5, -1.2, -1.5, -8.5, -2.2, -3.7 };
float testmatres[] = { -79.1, 19.97, -121.06, -119.67, 6.09, 19.3, 19.94, -68.35, -204.27, 63.93, -29.58, 99.59, -52.56, -131.93, -93.32, -71.29, 89.67, 4.93, 77.1, 3.56, -23.35, -207.05, -73.07, -0.97, -94.76, 56.13, 107.1, -22.31, 74.34, -11.1, -0.92, 76.05, -171.6, 42.81, -223.63, -191.33, 34.56, 262.8, 81.65, -91.71, -101.73, 49.73, -122.95, 131.49, -89.55, -138.48, -166.48, -129.01, -3.09, -98.22, -17.2, 80.73, 93.1, -81.11, -204.73, 78.04, -9.03, -59.14, -4.12, -129.48, 135.5, 118.45, -1.28, -21.24, -18.55, -10.3, 59.8, 2.94, -21.06, 78.86, -149.23, -42.12, 216.48, -118.05, 29.03, 95.86, -27.87, 130.09, -119.84, 82.28, -25.71, -60.23, -34.62, -19.24, 25.77, -69.52, -5.89, -51.1, -43.28, -84.62, -55.04, 102.2, -63.52, -70.35, -47.19, 79.9, 1.77, 179.43, -32.72, -24.96, 43.57, 87.36, 81.28, 31.24, 17.53, 55.59, 5.12, -74.44, 27.19, 56.99, -42.61, -82.5, 83.12, -132.68, 108.42, 85.6, -34.06, -89.24, 110.52, 27.92, 130.88, -37.1, -17.98, -59.94, 38.86, -38.34, 162.82, 145.88, 81.48, -83.83, 97.9, 7.62, -38.21, -250.37, -209.4, -18.19, -89.12, 24.04, 135.86, 12.5, 97.7, 12.68, -34.59, 112.01, 40.51, 138.54, 29.28, -29.25, -94.96, 148.68, 93.33, -6.13, 45.31, 86.59, 46.07, 50.18, -122.45, -13.85, 37.68, -46.17, 72.87, 59.55, -48.6, -29.04, 10.49, 4.21, -20.73, -3.91, -44.42, -9.91, -22.28, 79.43, -130.62, -73.32, -19.56, 86.07, 122.44, -43.53, -21.89, 42.36, -9, -78.93, 50.82, 103.81, -173.96, 154.95, 9.99, -155.39, 37.67, -118.31, 209.94, -22.33, 16.86, -101.45, -82.67, -4.07, 114.08, -72.14, -75.45, 74.53, -82.27, 55.49, -36.1, -187.52, 208.2, -16.63, 11.89, 0.41, 36.06, -168.99, 72.78, -89.05, -87.21, -52.48, -232.21, -72.81, 67.33, 49.38, 117.18, 72.38, 117.26, -18.65, -104.67, 156.95, 90.77, 112.15, 198.4, 167.07, -56.33, 16.56, -72.87, 89.17, 246.84, -51.78, 122.45, -102.28, 15.74, 269.9, 89.25, -21.41, 37.12, -3.11, 57.2, 193.35, 72.61, -194.87, 42.51, 85.38, -33.63, -147.13, -48.02, -81.27, -41.66, 80.4, 148.14, -4.4 };

bool uo_test_matmul()
{
  bool passed = true;

  {
    uo_avx_float v1 = _mm256_set_ps(1, 3, -5, 0, 0, 0, 0, 0);
    uo_avx_float v2 = _mm256_set_ps(4, -2, -1, 0, 0, 0, 0, 0);

    float res = uo_mm256_dotproduct_ps(&v1, &v2, 8);
    passed &= res == 3.0;
  }

  {
    uo_avx_float mat1[128 / uo_floats_per_avx_float];
    uo_avx_float mat2[128 / uo_floats_per_avx_float];
    uo_avx_float matres[256 / uo_floats_per_avx_float];
    float res[256];

    uo_mm256_load_ps(mat1, testmat1, 128);
    uo_mm256_load_ps(mat2, testmat2, 128);
    uo_mm256_matmul_ps(mat1, 16, 8, mat2, 16, matres);
    uo_mm256_store_ps(res, matres, 256);

    for (size_t i = 0; i < 256; i++)
    {
      float d = testmatres[i] - res[i];
      d = d > 0 ? d : -d;
      passed &= d < 0.02;
    }
  }

  return passed;
}
